<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Solfege Tower</title>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%; width: 100%; box-sizing: border-box; overflow: hidden; background: #faf8f0;
    }
    body, #app-wrapper {
      height: 100vh; width: 100vw;
      display: flex; flex-direction: column;
      justify-content: stretch; align-items: stretch; overflow: hidden;
    }
    .main-content {
      flex: 1 1 auto; display: flex; flex-direction: column; align-items: stretch; justify-content: stretch;
      min-height: 0; min-width: 0; overflow: hidden; position: relative;
    }
    .proportional-grid-wrapper {
      flex: 1 1 auto; min-height: 0; min-width: 0; display: flex; align-items: stretch; justify-content: center;
      position: relative; overflow: hidden; width: 100%; height: 100%;
    }
    .grid {
      /* Will be sized by JS! */
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(11, 1fr);
      gap: 0.575%; /* 15% larger than 0.5% */
      position: relative;
      background: transparent;
      margin: 0 auto;
      box-sizing: border-box;
      min-width: 0; min-height: 0;
      transition: width 0.2s, height 0.2s;
    }
    .cell, .note-button {
      border-radius: 1.15vmin; /* 15% larger than 1vmin */
      position: absolute;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      color: white;
      user-select: none;
      transition: transform 0.1s, background-color 0.3s, font-size 0.2s;
      outline: none;
      font-size: 3.22vw; /* 15% larger than 2.8vw */
      min-width: 0; min-height: 0;
      will-change: font-size;
    }
    .active { transform: scale(1.08); }
    .controls-bar {
      width: 100vw;
      min-height: 0;
      box-sizing: border-box;
      padding: 0.575vmin 0.575vmin 0 0.575vmin; /* 15% larger than 0.5vmin */
      background: #faf8f0;
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: stretch;
      gap: 1.725vw; /* 15% larger than 1.5vw */
      border-top: 1px solid #eee;
      z-index: 10;
      flex: 0 0 auto;
      transition: flex-direction 0.2s;
    }
    .control-area {
      outline: none;
      border-radius: 0.92vmin; /* 15% larger than 0.8vmin */
      box-shadow: none;
      transition: box-shadow 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: min(3.22vw, 3.22vh, 2.3em); /* 15% larger than 2.8vw/2.8vh/2em */
      padding: 0.345em 1.15em; /* 15% larger than 0.3em 1em */
      background: #fff;
      min-width: 0;
      min-height: 0;
      white-space: nowrap;
      margin: 0;
    }
    .control-area.selected {
      box-shadow: 0 0 0 0.69vmin #444a, 0 1px 8px #0002; /* 15% larger than 0.6vmin */
      background: #ffff;
    }
    .arrow {
      cursor: pointer;
      padding: 0.23em 0.575em; /* 15% larger than 0.2em 0.5em */
      user-select: none;
      font-size: inherit;
    }
    .volume-control {
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 0;
      gap: 0.575vw; /* 15% larger than 0.5vw */
      font-size: min(2.53vw, 2.53vh, 1.38em); /* 15% larger than 2.2vw/2.2vh/1.2em */
      user-select: none;
      padding: 0.115em 0.69em; /* 15% larger than 0.1em 0.6em */
      background: #fff;
      border-radius: 0.92vmin; /* 15% larger than 0.8vmin */
      margin: 0;
    }
    .volume-slider {
      width: min(18.4vw, 161px); /* 15% larger than 16vw/140px */
      accent-color: #007AFF;
      cursor: pointer;
      min-width: 69px; /* 15% larger than 60px */
      max-width: 207px; /* 15% larger than 180px */
    }
    .volume-label { font-weight: bold; margin-right: 0.345em; }
    .volume-value {
      width: 3.68em; /* 15% larger than 3.2em */
      text-align: left;
      color: #444;
      font-variant-numeric: tabular-nums;
      font-size: 1.15em; /* 15% larger than 1em */
      margin-left: 0.345em;
      letter-spacing: 0.046em;
    }
    @media (max-width: 550px) {
      .controls-bar {
        flex-direction: column;
        align-items: stretch;
        gap: 0;
        padding-bottom: 0;
        padding-top: 0;
      }
      .control-area, .volume-control {
        width: 100%;
        margin: 0;
        border-radius: 0;
        border-top: 1px solid #eee;
        border-bottom: none;
        box-shadow: none;
        background: #fff;
        justify-content: center;
        min-height: 0;
        min-width: 0;
      }
      .controls-bar > *:first-child {
        border-top: none !important;
      }
    }
  </style>
</head>
<body>
  <div id="app-wrapper">
    <div class="main-content">
      <div class="proportional-grid-wrapper">
        <div class="grid" id="grid"></div>
      </div>
    </div>
    <div class="controls-bar" id="controls-bar"></div>
  </div>
  <script>
    // ---- AUDIO & STATE ----
    const context = new (window.AudioContext || window.webkitAudioContext)();
    const waveforms = ['sine', 'triangle', 'square', 'sawtooth'];
    let currentWaveformIndex = 1;
    let currentWaveform = waveforms[currentWaveformIndex];
    let globalVolume = 0.4;

    const keyNames = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
    let currentKeyIndex = 0;

    const baseFrequencies = {
      'C4': 261.63, 'D4': 293.66, 'E4': 329.63, 'F4': 349.23, 'G4': 392.00, 'A4': 440.00, 'B4': 493.88,
      'C5': 523.25, 'D5': 587.33, 'E5': 659.25, 'G3': 196.00, 'A3': 220.00, 'B3': 246.94
    };
    let noteFrequencies = { ...baseFrequencies };

    const semitoneShiftMap = {'C':0,'Db':1,'D':2,'Eb':3,'E':4,'F':5,'Gb':6,'G':-5,'Ab':-4,'A':-3,'Bb':-2,'B':-1};
    function transposeFrequency(freq, semitoneShift) {
      return freq * Math.pow(2, semitoneShift / 12);
    }
    function updateTransposedFrequencies() {
      const shift = semitoneShiftMap[keyNames[currentKeyIndex]];
      noteFrequencies = {};
      for (const [note, freq] of Object.entries(baseFrequencies)) {
        noteFrequencies[note] = transposeFrequency(freq, shift);
      }
    }

    const noteColorsByKey = {
      'C': { 'Do': '#FF3B30', 'Re': '#FF9500', 'Mi': '#FFCC00', 'Fa': '#34C759', 'So': '#5af5fa', 'La': '#007AFF', 'Ti': '#AF52DE' },
      'Db': { 'Do': '#FF9500', 'Re': '#FFCC00', 'Mi': '#34C759', 'Fa': '#5af5fa', 'So': '#007AFF', 'La': '#AF52DE', 'Ti': '#FF3B30' },
      'D': { 'Do': '#FF9500', 'Re': '#FFCC00', 'Mi': '#34C759', 'Fa': '#5af5fa', 'So': '#007AFF', 'La': '#AF52DE', 'Ti': '#FF3B30' },
      'Eb': { 'Do': '#FFCC00', 'Re': '#34C759', 'Mi': '#5af5fa', 'Fa': '#007AFF', 'So': '#AF52DE', 'La': '#FF3B30', 'Ti': '#FF9500' },
      'E': { 'Do': '#FFCC00', 'Re': '#34C759', 'Mi': '#5af5fa', 'Fa': '#007AFF', 'So': '#AF52DE', 'La': '#FF3B30', 'Ti': '#FF9500' },
      'F': { 'Do': '#34C759', 'Re': '#5af5fa', 'Mi': '#007AFF', 'Fa': '#AF52DE', 'So': '#FF3B30', 'La': '#FF9500', 'Ti': '#FFCC00' },
      'Gb': { 'Do': '#5af5fa', 'Re': '#007AFF', 'Mi': '#AF52DE', 'Fa': '#FF3B30', 'So': '#FF9500', 'La': '#FFCC00', 'Ti': '#34C759' },
      'G': { 'Do': '#5af5fa', 'Re': '#007AFF', 'Mi': '#AF52DE', 'Fa': '#FF3B30', 'So': '#FF9500', 'La': '#FFCC00', 'Ti': '#34C759' },
      'Ab': { 'Do': '#007AFF', 'Re': '#AF52DE', 'Mi': '#FF3B30', 'Fa': '#FF9500', 'So': '#FFCC00', 'La': '#34C759', 'Ti': '#5af5fa' },
      'A': { 'Do': '#007AFF', 'Re': '#AF52DE', 'Mi': '#FF3B30', 'Fa': '#FF9500', 'So': '#FFCC00', 'La': '#34C759', 'Ti': '#5af5fa' },
      'Bb': { 'Do': '#AF52DE', 'Re': '#FF3B30', 'Mi': '#FF9500', 'Fa': '#FFCC00', 'So': '#34C759', 'La': '#5af5fa', 'Ti': '#007AFF' },
      'B': { 'Do': '#AF52DE', 'Re': '#FF3B30', 'Mi': '#FF9500', 'Fa': '#FFCC00', 'So': '#34C759', 'La': '#5af5fa', 'Ti': '#007AFF' }
    };

    const activeOscillators = {};
    const heldKeys = new Set();

    function startNote(key, freq) {
      if (activeOscillators[key]) return;
      const osc = context.createOscillator();
      const gain = context.createGain();
      const filter = context.createBiquadFilter();
      osc.type = currentWaveform;
      osc.frequency.value = freq;
      filter.type = 'lowpass';
      filter.frequency.setValueAtTime(1200, context.currentTime);
      filter.Q.value = 1;
      osc.connect(filter);
      filter.connect(gain);
      gain.connect(context.destination);
      gain.gain.setValueAtTime(globalVolume, context.currentTime);
      osc.start();
      activeOscillators[key] = { osc, gain };
    }
    function stopNote(key) {
      const active = activeOscillators[key];
      if (active) {
        const now = context.currentTime;
        active.gain.gain.cancelScheduledValues(now);
        active.gain.gain.setValueAtTime(active.gain.gain.value, now);
        active.gain.gain.exponentialRampToValueAtTime(0.001, now + 1.2);
        active.osc.stop(now + 1.3);
        delete activeOscillators[key];
      }
    }

    const positions = {
      '10a': [9, 0], '10b': [9, 1], '10c': [9, 2], '10d': [9, 3],
      '3a': [2, 0], '4a': [3, 0], '3b': [2, 1], '4b': [3, 1], '3c': [2, 2], '4c': [3, 2],
      '5a': [4, 0], '6a': [5, 0],
      '5b': [4, 1], '6b': [5, 1], '7b': [6, 1], '5c': [4, 2], '6c': [5, 2], '7c': [6, 2],
      '8b': [7, 1], '8c': [7, 2],
      '9b': [8, 1], '9c': [8, 2],
      '4d': [3, 3], '3d': [2, 3],
      '2c': [1, 2], '2d': [1, 3],
      '1c': [0, 2], '1d': [0, 3]
    };

    const buttons = [
      { name: 'Fa', key: '4', note: 'F4', cells: ['3a','4a'] },
      { name: 'So', key: '5', note: 'G4', cells: ['3b','4b','3c','4c'] },
      { name: 'Mi', key: '3', note: 'E4', cells: ['5a'] },
      { name: 'Re', key: '2', note: 'D4', cells: ['6a'] },
      { name: 'Do', key: '1', note: 'C4', cells: ['5b','6b','7b','5c','6c','7c'] },
      { name: 'La', key: 'a', note: 'A3', cells: ['8b'] },
      { name: 'Ti', key: 'q', note: 'B3', cells: ['8c'] },
      { name: 'So', key: 'z', note: 'G3', cells: ['9b','9c'] },
      { name: 'La', key: '6', note: 'A4', cells: ['4d'] },
      { name: 'Ti', key: '7', note: 'B4', cells: ['3d'] },
      { name: 'Do', key: '8', note: 'C5', cells: ['2c','2d'] },
      { name: 'Re', key: '9', note: 'D5', cells: ['1c'] },
      { name: 'Mi', key: '0', note: 'E5', cells: ['1d'] }
    ];

    const grid = document.getElementById('grid');
    const keyToDiv = {};

    function updateSolfegeColors() {
      const currentKey = keyNames[currentKeyIndex];
      const bgColors = noteColorsByKey[currentKey];
      const textColorsByKey = {
        'C':   { 'Do': '#FFFFFF', 'Re': '#FFFFFF', 'Mi': '#FFFFFF', 'Fa': '#FFFFFF', 'So': '#FFFFFF', 'La': '#FFFFFF', 'Ti': '#FFFFFF' },
        'Db':  { 'Do': '#0c027a', 'Re': '#0c027a', 'Mi': '#FFFFFF', 'Fa': '#0c027a', 'So': '#0c027a', 'La': '#0c027a', 'Ti': '#FFFFFF' },
        'D':   { 'Do': '#FFFFFF', 'Re': '#FFFFFF', 'Mi': '#820101', 'Fa': '#FFFFFF', 'So': '#FFFFFF', 'La': '#FFFFFF', 'Ti': '#820101' },
        'Eb':  { 'Do': '#0c027a', 'Re': '#FFFFFF', 'Mi': '#FFFFFF', 'Fa': '#0c027a', 'So': '#0c027a', 'La': '#FFFFFF', 'Ti': '#FFFFFF' },
        'E':   { 'Do': '#FFFFFF', 'Re': '#820101', 'Mi': '#820101', 'Fa': '#FFFFFF', 'So': '#FFFFFF', 'La': '#820101', 'Ti': '#820101' },
        'F':   { 'Do': '#FFFFFF', 'Re': '#FFFFFF', 'Mi': '#FFFFFF', 'Fa': '#0c027a', 'So': '#FFFFFF', 'La': '#FFFFFF', 'Ti': '#FFFFFF' },
        'Gb':  { 'Do': '#0c027a', 'Re': '#0c027a', 'Mi': '#0c027a', 'Fa': '#0c027a', 'So': '#0c027a', 'La': '#0c027a', 'Ti': '#FFFFFF' },
        'G':   { 'Do': '#FFFFFF', 'Re': '#FFFFFF', 'Mi': '#FFFFFF', 'Fa': '#FFFFFF', 'So': '#FFFFFF', 'La': '#FFFFFF', 'Ti': '#820101' },
        'Ab':  { 'Do': '#0c027a', 'Re': '#0c027a', 'Mi': '#FFFFFF', 'Fa': '#0c027a', 'So': '#0c027a', 'La': '#FFFFFF', 'Ti': '#FFFFFF' },
        'A':   { 'Do': '#FFFFFF', 'Re': '#FFFFFF', 'Mi': '#820101', 'Fa': '#FFFFFF', 'So': '#FFFFFF', 'La': '#820101', 'Ti': '#820101' },
        'Bb':  { 'Do': '#0c027a', 'Re': '#FFFFFF', 'Mi': '#FFFFFF', 'Fa': '#0c027a', 'So': '#FFFFFF', 'La': '#FFFFFF', 'Ti': '#FFFFFF' },
        'B':   { 'Do': '#FFFFFF', 'Re': '#820101', 'Mi': '#820101', 'Fa': '#FFFFFF', 'So': '#820101', 'La': '#820101', 'Ti': '#820101' }
      };
      const textColors = textColorsByKey[currentKey];
      buttons.forEach(btn => {
        const div = keyToDiv[btn.key];
        if (div) {
          if (bgColors[btn.name]) div.style.backgroundColor = bgColors[btn.name];
          if (textColors[btn.name]) div.style.color = textColors[btn.name];
        }
      });
    }

    // ---- GRID CELLS ----
    for (let r = 0; r < 11; r++) {
      for (let c = 0; c < 4; c++) {
        const div = document.createElement('div');
        div.className = 'cell';
        grid.appendChild(div);
      }
    }

    // ---- CONTROLS (bottom bar) ----
    const controlsBar = document.getElementById('controls-bar');
    const keyButton = document.createElement('div');
    keyButton.className = 'control-area';
    keyButton.tabIndex = 0;
    keyButton.setAttribute('aria-label', 'Key control');
    keyButton.innerHTML = '<div class="arrow" id="key-left">&#9664;</div><div id="key-name">C Major</div><div class="arrow" id="key-right">&#9654;</div>';
    const waveButton = document.createElement('div');
    waveButton.className = 'control-area';
    waveButton.tabIndex = 0;
    waveButton.setAttribute('aria-label', 'Waveform control');
    waveButton.innerHTML = '<div class="arrow" id="left-arrow">&#9664;</div><div id="waveform-name">triangle</div><div class="arrow" id="right-arrow">&#9654;</div>';
    const volumeControl = document.createElement('div');
    volumeControl.className = 'volume-control';
    volumeControl.innerHTML = `
      <span class="volume-label" id="volume-label" for="volume-slider">Volume</span>
      <input type="range" min="0" max="1" step="0.01" value="0.4" id="volume-slider" class="volume-slider" aria-label="Volume slider">
      <span class="volume-value" id="volume-value">40%</span>
    `;
    volumeControl.tabIndex = 0;
    volumeControl.setAttribute('aria-label', 'Volume control');
    volumeControl.style.outline = 'none';
    volumeControl.addEventListener('focus', () => {
      volumeControl.style.boxShadow = '0 0 0 0.575vmin #007aff88';
    });
    volumeControl.addEventListener('blur', () => {
      volumeControl.style.boxShadow = 'none';
    });
    volumeControl.addEventListener('keydown', (e) => {
      const slider = document.getElementById('volume-slider');
      if (e.key === 'ArrowLeft' || e.key === 'ArrowDown') {
        slider.value = Math.max(0, parseFloat(slider.value) - 0.02);
        slider.dispatchEvent(new Event('input'));
        e.preventDefault();
      }
      if (e.key === 'ArrowRight' || e.key === 'ArrowUp') {
        slider.value = Math.min(1, parseFloat(slider.value) + 0.02);
        slider.dispatchEvent(new Event('input'));
        e.preventDefault();
      }
    });
    controlsBar.appendChild(keyButton);
    controlsBar.appendChild(waveButton);
    controlsBar.appendChild(volumeControl);
    document.getElementById("key-left").onclick = () => {
      currentKeyIndex = (currentKeyIndex - 1 + keyNames.length) % keyNames.length;
      document.getElementById("key-name").textContent = keyNames[currentKeyIndex] + ' Major';
      updateTransposedFrequencies();
      updateSolfegeColors();
    };
    document.getElementById("key-right").onclick = () => {
      currentKeyIndex = (currentKeyIndex + 1) % keyNames.length;
      document.getElementById("key-name").textContent = keyNames[currentKeyIndex] + ' Major';
      updateTransposedFrequencies();
      updateSolfegeColors();
    };
    document.getElementById("left-arrow").onclick = () => {
      currentWaveformIndex = (currentWaveformIndex - 1 + waveforms.length) % waveforms.length;
      currentWaveform = waveforms[currentWaveformIndex];
      document.getElementById("waveform-name").textContent = currentWaveform;
    };
    document.getElementById("right-arrow").onclick = () => {
      currentWaveformIndex = (currentWaveformIndex + 1) % waveforms.length;
      currentWaveform = waveforms[currentWaveformIndex];
      document.getElementById("waveform-name").textContent = currentWaveform;
    };
    const volumeSlider = document.getElementById('volume-slider');
    const volumeValue = document.getElementById('volume-value');
    volumeSlider.value = globalVolume;
    volumeValue.textContent = `${Math.round(globalVolume * 100)}%`;
    volumeSlider.addEventListener('input', () => {
      globalVolume = parseFloat(volumeSlider.value);
      volumeValue.textContent = `${Math.round(globalVolume * 100)}%`;
    });
    let controlMode = null;
    function selectControl(which) {
      controlMode = which;
      keyButton.classList.toggle('selected', which === 'key');
      waveButton.classList.toggle('selected', which === 'waveform');
      volumeControl.style.boxShadow = which === 'volume' ? '0 0 0 0.575vmin #007aff88' : 'none';
      if (which === 'key') keyButton.focus();
      if (which === 'waveform') waveButton.focus();
      if (which === 'volume') volumeControl.focus();
    }
    keyButton.onclick = () => selectControl('key');
    keyButton.onfocus = () => selectControl('key');
    waveButton.onclick = () => selectControl('waveform');
    waveButton.onfocus = () => selectControl('waveform');
    volumeControl.onclick = () => selectControl('volume');
    volumeControl.onfocus = () => selectControl('volume');
    keyButton.onblur = () => keyButton.classList.remove('selected');
    waveButton.onblur = () => waveButton.classList.remove('selected');
    buttons.forEach(btn => {
      const div = document.createElement('div');
      div.className = 'note-button';
      div.textContent = btn.name;
      div.style.outline = 'none';
      if (btn.name === 'Do' && btn.key === '1') div.style.fontSize = 'min(9.2vw, 9.2vh, 8.05em)'; // 15% larger
      if (btn.name === 'So' && btn.key === '5') div.style.fontSize = 'min(6.9vw, 6.9vh, 5.18em)'; // 15% larger
      const color = noteColorsByKey[keyNames[currentKeyIndex]][btn.name] || '#ccc';
      div.style.backgroundColor = color;
      const rows = [...new Set(btn.cells.map(c => positions[c][0]))];
      const cols = [...new Set(btn.cells.map(c => positions[c][1]))];
      const top = Math.min(...rows) * (100 / 11);
      const left = Math.min(...cols) * (100 / 4);
      const height = rows.length * (100 / 11) - 0.5;
      const width = cols.length * (100 / 4) - 0.5;
      div.style.top = `${top}%`;
      div.style.left = `${left}%`;
      div.style.height = `${height}%`;
      div.style.width = `${width}%`;
      div.addEventListener('mousedown', (e) => {
        e.preventDefault();
        startNote(btn.key, noteFrequencies[btn.note]);
        div.classList.add('active');
        window.focus();
      });
      div.addEventListener('mouseup', () => {
        stopNote(btn.key);
        div.classList.remove('active');
      });
      div.addEventListener('mouseleave', () => {
        stopNote(btn.key);
        div.classList.remove('active');
      });
      div.addEventListener('touchstart', (e) => {
        e.preventDefault();
        startNote(btn.key, noteFrequencies[btn.note]);
        div.classList.add('active');
        window.focus();
      });
      div.addEventListener('touchend', () => {
        stopNote(btn.key);
        div.classList.remove('active');
      });
      div.addEventListener('touchcancel', () => {
        stopNote(btn.key);
        div.classList.remove('active');
      });
      grid.appendChild(div);
      keyToDiv[btn.key] = div;
    });
    window.addEventListener('keydown', (e) => {
      if (document.activeElement === keyButton && (e.key === 'ArrowLeft' || e.key === 'ArrowRight')) {
        if (e.key === 'ArrowLeft') document.getElementById('key-left').click();
        else if (e.key === 'ArrowRight') document.getElementById('key-right').click();
        e.preventDefault();
        return;
      }
      if (document.activeElement === waveButton && (e.key === 'ArrowLeft' || e.key === 'ArrowRight')) {
        if (e.key === 'ArrowLeft') document.getElementById('left-arrow').click();
        else if (e.key === 'ArrowRight') document.getElementById('right-arrow').click();
        e.preventDefault();
        return;
      }
      if (document.activeElement === volumeControl && (e.key === 'ArrowLeft' || e.key === 'ArrowRight' || e.key === 'ArrowUp' || e.key === 'ArrowDown')) {
        e.preventDefault();
        return;
      }
      if (!heldKeys.has(e.key)) {
        heldKeys.add(e.key);
        const btn = buttons.find(b => b.key === e.key);
        if (btn) {
          startNote(btn.key, noteFrequencies[btn.note]);
          if (keyToDiv[btn.key]) keyToDiv[btn.key].classList.add('active');
        }
      }
    });
    window.addEventListener('keyup', (e) => {
      heldKeys.delete(e.key);
      stopNote(e.key);
      if (keyToDiv[e.key]) keyToDiv[e.key].classList.remove('active');
    });

    // --- Grid should NEVER get wider than maxWidth; always fill all vertical space above controls; centered horizontally ---
    function resizeGrid() {
      const controls = document.getElementById('controls-bar');
      const propGridWrapper = document.querySelector('.proportional-grid-wrapper');
      const gridEl = document.getElementById('grid');
      const controlsHeight = controls.getBoundingClientRect().height;
      const availableHeight = window.innerHeight - controlsHeight;

      // grid width: fixed maximum, or availableHeight * (4/11) (4 columns, 11 rows)
      const gridRatio = 4/11;
      let maxWidth = Math.min(window.innerWidth, Math.round(availableHeight * gridRatio * 1.15), 805); // 15% larger than 700px
      gridEl.style.width = maxWidth + 'px';
      gridEl.style.height = availableHeight * 1.15 + 'px'; // 15% larger
      gridEl.style.marginLeft = "auto";
      gridEl.style.marginRight = "auto";
      gridEl.style.marginTop = "0";
      gridEl.style.marginBottom = "0";

      // Scale font-size for all note-buttons and cells for readability
      const fontSize = Math.min((availableHeight * 1.15)/11, maxWidth/4) * 0.5;
      gridEl.querySelectorAll('.note-button').forEach(div=>{
        div.style.fontSize = fontSize + 'px';
      });
      gridEl.querySelectorAll('.cell').forEach(div=>{
        div.style.fontSize = fontSize + 'px';
      });
    }
    window.addEventListener('resize', resizeGrid);
    window.addEventListener('DOMContentLoaded', resizeGrid);
    setTimeout(resizeGrid, 200);
    const mq = window.matchMedia("(max-width: 550px)");
    mq.addEventListener("change", resizeGrid);
  </script>
</body>
</html>
