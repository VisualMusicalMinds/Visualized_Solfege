<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Solfege Tower</title>
  <style>
    html, body {
  margin: 0;
  padding: 0;
  height: 100vh;
  width: 100vw;
  display: flex;
  align-items: center;
  justify-content: center;
}
    .grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(11, 1fr);
      gap: 0.5vmin;
      width: 90vmin;
      height: 90vmin;
      position: relative;
    }
    .cell, .note-button {
      border-radius: 1vmin;
      position: absolute;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      color: white;
      user-select: none;
      transition: transform 0.1s ease, background-color 0.3s ease;
      font-size: clamp(2rem, 6vmin, 4rem);
    }
    .active {
      transform: scale(1.1);
    }
    .arrow {
      cursor: pointer;
      padding: 0.5vmin;
      user-select: none;
    }
  </style>
</head>
<body>
  <div class="grid" id="grid"></div>

  <script>
    const context = new (window.AudioContext || window.webkitAudioContext)();
    const waveforms = ['sine', 'triangle', 'square', 'sawtooth'];
    let currentWaveformIndex = 1;
    let currentWaveform = waveforms[currentWaveformIndex];
    let globalVolume = 0.4;

    const keyNames = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
    let currentKeyIndex = 0;

    const baseFrequencies = {
  'C4': 261.63,
  'D4': 293.66,
  'E4': 329.63,
  'F4': 349.23,
  'G4': 392.00,
  'A4': 440.00,
  'B4': 493.88,
  'C5': 523.25,
  'D5': 587.33,
  'E5': 659.25,
  'G3': 196.00,
  'A3': 220.00,
  'B3': 246.94
};
let noteFrequencies = { ...baseFrequencies };

const semitoneShiftMap = {
  'C': 0,
  'Db': 1,
  'D': 2,
  'Eb': 3,
  'E': 4,
  'F': 5,
  'Gb': 6,
  'G': -5,
  'Ab': -4,
  'A': -3,
  'Bb': -2,
  'B': -1
};

function transposeFrequency(freq, semitoneShift) {
  return freq * Math.pow(2, semitoneShift / 12);
}

function updateTransposedFrequencies() {
  const shift = semitoneShiftMap[keyNames[currentKeyIndex]];
  noteFrequencies = {};
  for (const [note, freq] of Object.entries(baseFrequencies)) {
    noteFrequencies[note] = transposeFrequency(freq, shift);
  }
}

    const noteColorsByKey = {
  'C': { 'Do': '#FF3B30', 'Re': '#FF9500', 'Mi': '#FFCC00', 'Fa': '#34C759', 'So': '#5af5fa', 'La': '#007AFF', 'Ti': '#AF52DE' },
  'Db': { 'Do': '#FF9500', 'Re': '#FFCC00', 'Mi': '#34C759', 'Fa': '#5af5fa', 'So': '#007AFF', 'La': '#AF52DE', 'Ti': '#FF3B30' },
  'D': { 'Do': '#FF9500', 'Re': '#FFCC00', 'Mi': '#34C759', 'Fa': '#5af5fa', 'So': '#007AFF', 'La': '#AF52DE', 'Ti': '#FF3B30' },
  'Eb': { 'Do': '#FFCC00', 'Re': '#34C759', 'Mi': '#5af5fa', 'Fa': '#007AFF', 'So': '#AF52DE', 'La': '#FF3B30', 'Ti': '#FF9500' },
  'E': { 'Do': '#FFCC00', 'Re': '#34C759', 'Mi': '#5af5fa', 'Fa': '#007AFF', 'So': '#AF52DE', 'La': '#FF3B30', 'Ti': '#FF9500' },
  'F': { 'Do': '#34C759', 'Re': '#5af5fa', 'Mi': '#007AFF', 'Fa': '#AF52DE', 'So': '#FF3B30', 'La': '#FF9500', 'Ti': '#FFCC00' },
  'Gb': { 'Do': '#5af5fa', 'Re': '#007AFF', 'Mi': '#AF52DE', 'Fa': '#FF3B30', 'So': '#FF9500', 'La': '#FFCC00', 'Ti': '#34C759' },
  'G': { 'Do': '#5af5fa', 'Re': '#007AFF', 'Mi': '#AF52DE', 'Fa': '#FF3B30', 'So': '#FF9500', 'La': '#FFCC00', 'Ti': '#34C759' },
  'Ab': { 'Do': '#007AFF', 'Re': '#AF52DE', 'Mi': '#FF3B30', 'Fa': '#FF9500', 'So': '#FFCC00', 'La': '#34C759', 'Ti': '#5af5fa' },
  'A': { 'Do': '#007AFF', 'Re': '#AF52DE', 'Mi': '#FF3B30', 'Fa': '#FF9500', 'So': '#FFCC00', 'La': '#34C759', 'Ti': '#5af5fa' },
  'Bb': { 'Do': '#AF52DE', 'Re': '#FF3B30', 'Mi': '#FF9500', 'Fa': '#FFCC00', 'So': '#34C759', 'La': '#5af5fa', 'Ti': '#007AFF' },
  'B': { 'Do': '#AF52DE', 'Re': '#FF3B30', 'Mi': '#FF9500', 'Fa': '#FFCC00', 'So': '#34C759', 'La': '#5af5fa', 'Ti': '#007AFF' }
};

    const activeOscillators = {};
    const heldKeys = new Set();

    function startNote(key, freq) {
      if (activeOscillators[key]) return;
      const osc = context.createOscillator();
      const gain = context.createGain();
      const filter = context.createBiquadFilter();
      osc.type = currentWaveform;
      osc.frequency.value = freq;
      filter.type = 'lowpass';
      filter.frequency.setValueAtTime(1200, context.currentTime);
      filter.Q.value = 1;
      osc.connect(filter);
      filter.connect(gain);
      gain.connect(context.destination);
      gain.gain.setValueAtTime(globalVolume, context.currentTime);
      osc.start();
      activeOscillators[key] = { osc, gain };
    }

    function stopNote(key) {
      const active = activeOscillators[key];
      if (active) {
        const now = context.currentTime;
        active.gain.gain.cancelScheduledValues(now);
        active.gain.gain.setValueAtTime(active.gain.gain.value, now);
        active.gain.gain.exponentialRampToValueAtTime(0.001, now + 1.2);
        active.osc.stop(now + 1.3);
        delete activeOscillators[key];
      }
    }

    const positions = {
      '10a': [9, 0], '10b': [9, 1], '10c': [9, 2], '10d': [9, 3],
      '3a': [2, 0], '4a': [3, 0], '3b': [2, 1], '4b': [3, 1], '3c': [2, 2], '4c': [3, 2],
      '5a': [4, 0], '6a': [5, 0],
      '5b': [4, 1], '6b': [5, 1], '7b': [6, 1], '5c': [4, 2], '6c': [5, 2], '7c': [6, 2],
      '8b': [7, 1], '8c': [7, 2],
      '9b': [8, 1], '9c': [8, 2],
      '4d': [3, 3], '3d': [2, 3],
      '2c': [1, 2], '2d': [1, 3],
      '1c': [0, 2], '1d': [0, 3]
    };

    const buttons = [
      { name: 'Fa', key: '4', note: 'F4', cells: ['3a','4a'] },
      { name: 'So', key: '5', note: 'G4', cells: ['3b','4b','3c','4c'] },
      { name: 'Mi', key: '3', note: 'E4', cells: ['5a'] },
      { name: 'Re', key: '2', note: 'D4', cells: ['6a'] },
      { name: 'Do', key: '1', note: 'C4', cells: ['5b','6b','7b','5c','6c','7c'] },
      { name: 'La', key: 'a', note: 'A3', cells: ['8b'] },
      { name: 'Ti', key: 'q', note: 'B3', cells: ['8c'] },
      { name: 'So', key: 'z', note: 'G3', cells: ['9b','9c'] },
      { name: 'La', key: '6', note: 'A4', cells: ['4d'] },
      { name: 'Ti', key: '7', note: 'B4', cells: ['3d'] },
      { name: 'Do', key: '8', note: 'C5', cells: ['2c','2d'] },
      { name: 'Re', key: '9', note: 'D5', cells: ['1c'] },
      { name: 'Mi', key: '0', note: 'E5', cells: ['1d'] }
    ];

    const grid = document.getElementById('grid');
    const keyToDiv = {};

function updateSolfegeColors() {
  const currentKey = keyNames[currentKeyIndex];
  const bgColors = noteColorsByKey[currentKey];
  const textColorsByKey = {
    'C':   { 'Do': '#FFFFFF', 'Re': '#FFFFFF', 'Mi': '#FFFFFF', 'Fa': '#FFFFFF', 'So': '#FFFFFF', 'La': '#FFFFFF', 'Ti': '#FFFFFF' },
    'Db':  { 'Do': '#0c027a', 'Re': '#0c027a', 'Mi': '#FFFFFF', 'Fa': '#0c027a', 'So': '#0c027a', 'La': '#0c027a', 'Ti': '#FFFFFF' },
    'D':   { 'Do': '#FFFFFF', 'Re': '#FFFFFF', 'Mi': '#820101', 'Fa': '#FFFFFF', 'So': '#FFFFFF', 'La': '#FFFFFF', 'Ti': '#820101' },
    'Eb':  { 'Do': '#0c027a', 'Re': '#FFFFFF', 'Mi': '#FFFFFF', 'Fa': '#0c027a', 'So': '#0c027a', 'La': '#FFFFFF', 'Ti': '#FFFFFF' },
    'E':   { 'Do': '#FFFFFF', 'Re': '#820101', 'Mi': '#820101', 'Fa': '#FFFFFF', 'So': '#FFFFFF', 'La': '#820101', 'Ti': '#820101' },
    'F':   { 'Do': '#FFFFFF', 'Re': '#FFFFFF', 'Mi': '#FFFFFF', 'Fa': '#0c027a', 'So': '#FFFFFF', 'La': '#FFFFFF', 'Ti': '#FFFFFF' },
    'Gb':  { 'Do': '#0c027a', 'Re': '#0c027a', 'Mi': '#0c027a', 'Fa': '#0c027a', 'So': '#0c027a', 'La': '#0c027a', 'Ti': '#FFFFFF' },
    'G':   { 'Do': '#FFFFFF', 'Re': '#FFFFFF', 'Mi': '#FFFFFF', 'Fa': '#FFFFFF', 'So': '#FFFFFF', 'La': '#FFFFFF', 'Ti': '#820101' },
    'Ab':  { 'Do': '#0c027a', 'Re': '#0c027a', 'Mi': '#FFFFFF', 'Fa': '#0c027a', 'So': '#0c027a', 'La': '#FFFFFF', 'Ti': '#FFFFFF' },
    'A':   { 'Do': '#FFFFFF', 'Re': '#FFFFFF', 'Mi': '#820101', 'Fa': '#FFFFFF', 'So': '#FFFFFF', 'La': '#820101', 'Ti': '#820101' },
    'Bb':  { 'Do': '#0c027a', 'Re': '#FFFFFF', 'Mi': '#FFFFFF', 'Fa': '#0c027a', 'So': '#FFFFFF', 'La': '#FFFFFF', 'Ti': '#FFFFFF' },
    'B':   { 'Do': '#FFFFFF', 'Re': '#820101', 'Mi': '#820101', 'Fa': '#FFFFFF', 'So': '#820101', 'La': '#820101', 'Ti': '#820101' }
  };
  const textColors = textColorsByKey[currentKey];
  buttons.forEach(btn => {
    const div = keyToDiv[btn.key];
    if (div) {
      if (bgColors[btn.name]) div.style.backgroundColor = bgColors[btn.name];
      if (textColors[btn.name]) div.style.color = textColors[btn.name];
    }
  });
}
 

    for (let r = 0; r < 11; r++) {
      for (let c = 0; c < 4; c++) {
        const div = document.createElement('div');
        div.className = 'cell';
        grid.appendChild(div);
      }
    }

    const bottomControlWrap = document.createElement('div');
bottomControlWrap.style.position = 'absolute';
bottomControlWrap.style.display = 'flex';
bottomControlWrap.style.flexDirection = 'column';
bottomControlWrap.style.alignItems = 'center';
bottomControlWrap.style.justifyContent = 'center';
bottomControlWrap.style.top = `${9.4 * (100 / 11)}vmin`;
bottomControlWrap.style.left = '0';
bottomControlWrap.style.width = '100%';
bottomControlWrap.style.height = `${1.5 * (100 / 11)}vmin`;
bottomControlWrap.style.rowGap = '0.3vmin';

    const keyButton = document.createElement('div');
keyButton.innerHTML = '<div class=\"arrow\" id=\"key-left\">&#9664;</div><div id=\"key-name\">C Major</div><div class=\"arrow\" id=\"key-right\">&#9654;</div>';
    keyButton.style.position = 'static';
keyButton.style.display = 'flex';
keyButton.style.alignItems = 'center';
keyButton.style.justifyContent = 'center';
keyButton.style.width = '100%';
keyButton.style.height = '100%';
keyButton.style.fontSize = 'clamp(1.6rem, 3.5vmin, 2.4rem)';
const waveButton = document.createElement('div');
waveButton.innerHTML = '<div class="arrow" id="left-arrow">&#9664;</div><div id="waveform-name">triangle</div><div class="arrow" id="right-arrow">&#9654;</div>';
waveButton.style.position = 'static';
waveButton.style.display = 'flex';
waveButton.style.alignItems = 'center';
waveButton.style.justifyContent = 'center';
waveButton.style.width = '100%';
waveButton.style.height = '100%';
waveButton.style.fontSize = 'clamp(1.6rem, 3.5vmin, 2.4rem)';
bottomControlWrap.appendChild(keyButton);
bottomControlWrap.appendChild(waveButton);
grid.appendChild(bottomControlWrap);

    // Set up event handlers once buttons are in the DOM
    document.getElementById("key-left").onclick = () => {
      currentKeyIndex = (currentKeyIndex - 1 + keyNames.length) % keyNames.length;
      document.getElementById("key-name").textContent = keyNames[currentKeyIndex] + ' Major';
      updateTransposedFrequencies();
      updateSolfegeColors();
    };
    document.getElementById("key-right").onclick = () => {
  currentKeyIndex = (currentKeyIndex + 1) % keyNames.length;
  document.getElementById("key-name").textContent = keyNames[currentKeyIndex] + ' Major';
  updateTransposedFrequencies();
  updateSolfegeColors();
  updateTransposedFrequencies();
    };
    document.getElementById("left-arrow").onclick = () => {
      currentWaveformIndex = (currentWaveformIndex - 1 + waveforms.length) % waveforms.length;
      currentWaveform = waveforms[currentWaveformIndex];
      document.getElementById("waveform-name").textContent = currentWaveform;
    };
    document.getElementById("right-arrow").onclick = () => {
      currentWaveformIndex = (currentWaveformIndex + 1) % waveforms.length;
      currentWaveform = waveforms[currentWaveformIndex];
      document.getElementById("waveform-name").textContent = currentWaveform;
    };

    buttons.forEach(btn => {
      const div = document.createElement('div');
      div.className = 'note-button';
      div.textContent = btn.name;
      if (btn.name === 'Do' && btn.key === '1') div.style.fontSize = 'clamp(6rem, 12vmin, 8rem)';
      if (btn.name === 'So' && btn.key === '5') div.style.fontSize = 'clamp(4rem, 8vmin, 6rem)';
      const color = noteColorsByKey[keyNames[currentKeyIndex]][btn.name] || '#ccc';
      div.style.backgroundColor = color;

      const rows = [...new Set(btn.cells.map(c => positions[c][0]))];
      const cols = [...new Set(btn.cells.map(c => positions[c][1]))];

      const top = Math.min(...rows) * (100 / 11);
      const left = Math.min(...cols) * (90 / 4);
      const height = rows.length * (100 / 11) - 0.5;
      const width = cols.length * (90 / 4) - 0.5;

      div.style.top = `${top}vmin`;
      div.style.left = `${left}vmin`;
      div.style.height = `${height}vmin`;
      div.style.width = `${width}vmin`;

      div.addEventListener('mousedown', () => {
        startNote(btn.key, noteFrequencies[btn.note]);
        div.classList.add('active');
      });
      div.addEventListener('mouseup', () => {
        stopNote(btn.key);
        div.classList.remove('active');
      });
      div.addEventListener('mouseleave', () => {
        stopNote(btn.key);
        div.classList.remove('active');
      });

      grid.appendChild(div);
      keyToDiv[btn.key] = div;
    });

    document.addEventListener('keydown', (e) => {
      heldKeys.add(e.key);
      const btn = buttons.find(b => b.key === e.key);
      if (btn) {
        startNote(btn.key, noteFrequencies[btn.note]);
        if (keyToDiv[btn.key]) keyToDiv[btn.key].classList.add('active');
      }
    });

    document.addEventListener('keyup', (e) => {
      heldKeys.delete(e.key);
      stopNote(e.key);
      if (keyToDiv[e.key]) keyToDiv[e.key].classList.remove('active');
    });
  let controlMode = null; // 'waveform' or 'key'

waveButton.onclick = () => controlMode = 'waveform';
keyButton.onclick = () => controlMode = 'key';

document.addEventListener('keydown', (e) => {
  if (document.activeElement === document.body) {
    if (controlMode === 'waveform') {
      if (e.key === 'ArrowLeft') document.getElementById('left-arrow').click();
      else if (e.key === 'ArrowRight') document.getElementById('right-arrow').click();
    } else if (controlMode === 'key') {
      if (e.key === 'ArrowLeft') document.getElementById('key-left').click();
      else if (e.key === 'ArrowRight') document.getElementById('key-right').click();
    }
  }
});
</script>
</body>
</html>
